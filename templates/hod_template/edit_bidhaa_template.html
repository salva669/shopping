{% extends 'hod_template/base_template.html' %}
{% load custom_filters %}
{% block page_title %}
Edit Bidhaa | {{ bidhaa.jina }} | #ID: {{ bidhaa.id }}
{% endblock page_title %}

{% block main_content %}
<!-- Main content -->
<section class="content">
  <div class="container-fluid">
    
    <!-- Breadcrumb -->
    <div class="row mb-2">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'manage_bidhaa' %}">Manage Bidhaa</a></li>
            <li class="breadcrumb-item active">Edit {{ bidhaa.jina }}</li>
          </ol>
        </nav>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <!-- Card -->
        <div class="card card-success">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-edit mr-2"></i>Edit Bidhaa: {{ bidhaa.jina }}
            </h3>
          </div>
          
          <!-- Current Image Preview -->
          {% if bidhaa.profile_pic %}
          <div class="card-body pb-0">
            <div class="alert alert-info">
              <div class="row align-items-center">
                <div class="col-auto">
                  <img src="{{ bidhaa.profile_pic.url }}" 
                       alt="{{ bidhaa.jina }}" 
                       style="width:80px; height:80px; object-fit:cover; border-radius:5px;"
                       class="img-thumbnail">
                </div>
                <div class="col">
                  <strong><i class="fas fa-info-circle"></i> Current Image</strong>
                  <p class="mb-0">
                    <small class="text-muted">Leave image field empty to keep this image, or upload new one to replace it.</small>
                  </p>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          
          <!-- FORM - Critical: Posts to SAME URL (no action attribute) -->
          <form role="form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="card-body">
              
              <!-- Messages -->
              {% if messages %}
                {% for message in messages %}
                  {% if message.tags == 'error' %}
                    <div class="alert alert-danger alert-dismissible">
                      <button type="button" class="close" data-dismiss="alert">&times;</button>
                      {{ message }}
                    </div>
                  {% endif %}
                  {% if message.tags == 'success' %}
                    <div class="alert alert-success alert-dismissible">
                      <button type="button" class="close" data-dismiss="alert">&times;</button>
                      {{ message }}
                    </div>
                  {% endif %}
                {% endfor %}
              {% endif %}

              <!-- Form Fields -->
              {% for field in form %}
                <div class="form-group">
                  {{ field.errors }}
                  {{ field.label_tag }}
                  {{ field }}
                  {% if field.help_text %}
                    <small class="form-text text-muted">{{ field.help_text }}</small>
                  {% endif %}
                </div>
              {% endfor %}

            </div>
            <!-- /.card-body -->

            <div class="card-footer">
              <button type="submit" class="btn btn-success btn-lg btn-block">
                <i class="fas fa-save"></i> {{ button_text }}
              </button>
              <a href="{% url 'manage_bidhaa' %}" class="btn btn-secondary btn-block">
                <i class="fas fa-arrow-left"></i> Cancel & Back to List
              </a>
            </div>
          </form>
        </div>
        <!-- /.card -->
      </div>
    </div>
  </div>
</section>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image preview
    const imageInput = document.querySelector('input[name="profile_pic"]');
    if (imageInput) {
        imageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const existingPreview = document.querySelector('.new-image-preview');
                    if (existingPreview) existingPreview.remove();
                    
                    const preview = document.createElement('div');
                    preview.className = 'new-image-preview mt-2 alert alert-success';
                    preview.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <img src="${e.target.result}" 
                                     style="width:80px; height:80px; object-fit:cover; border-radius:5px;"
                                     class="img-thumbnail">
                            </div>
                            <div class="col">
                                <strong><i class="fas fa-check"></i> New Image Selected</strong>
                                <p class="mb-0"><small>This will replace the current image.</small></p>
                            </div>
                        </div>
                    `;
                    imageInput.parentNode.appendChild(preview);
                };
                reader.readAsDataURL(file);
            }
        });
    }
});
</script>
{% endblock main_content %}