{% extends 'hod_template/base_template.html' %}
{% load custom_filters %}
{% block page_title %}
Sales Dashboard
{% endblock page_title %}

{% block main_content %}
<section class="content">
  <div class="container-fluid">
    
    <!-- Page Header -->
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1><i class="fas fa-chart-line"></i> Sales Dashboard</h1>
      </div>
      <div class="col-sm-6">
        <div class="float-sm-right">
          <a href="{% url 'make_sale' %}" class="btn btn-primary">
            <i class="fas fa-cash-register"></i> New Sale
          </a>
        </div>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row">
      <!-- Today's Sales -->
      <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
          <div class="inner">
            <h3>{{ today_total|floatformat:0 }}</h3>
            <p>Today's Sales (TZS)</p>
          </div>
          <div class="icon">
            <i class="fas fa-calendar-day"></i>
          </div>
          <a href="{% url 'sales_history' %}" class="small-box-footer">
            {{ today_count }} transactions <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>

      <!-- This Week -->
      <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
          <div class="inner">
            <h3>{{ week_total|floatformat:0 }}</h3>
            <p>This Week (TZS)</p>
          </div>
          <div class="icon">
            <i class="fas fa-calendar-week"></i>
          </div>
          <a href="{% url 'sales_history' %}" class="small-box-footer">
            View Details <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>

      <!-- This Month -->
      <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
          <div class="inner">
            <h3>{{ month_total|floatformat:0 }}</h3>
            <p>This Month (TZS)</p>
          </div>
          <div class="icon">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <a href="{% url 'sales_history' %}" class="small-box-footer">
            View Report <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>

      <!-- Quick Access -->
      <div class="col-lg-3 col-6">
        <div class="small-box bg-danger">
          <div class="inner">
            <h3><i class="fas fa-shopping-cart"></i></h3>
            <p>Quick Sale</p>
          </div>
          <div class="icon">
            <i class="fas fa-cash-register"></i>
          </div>
          <a href="{% url 'make_sale' %}" class="small-box-footer">
            Start New Sale <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Top Selling Products -->
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-trophy"></i> Top Selling Products
            </h3>
          </div>
          <div class="card-body table-responsive p-0">
            {% if top_products %}
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th width="50">Rank</th>
                    <th>Product Name</th>
                    <th>Units Sold</th>
                    <th>Revenue (TZS)</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for product in top_products %}
                    <tr>
                      <td>
                        {% if forloop.counter == 1 %}
                          <span class="badge badge-warning"><i class="fas fa-trophy"></i> #1</span>
                        {% elif forloop.counter == 2 %}
                          <span class="badge badge-secondary"><i class="fas fa-medal"></i> #2</span>
                        {% elif forloop.counter == 3 %}
                          <span class="badge badge-info"><i class="fas fa-medal"></i> #3</span>
                        {% else %}
                          <span class="badge badge-light">#{{ forloop.counter }}</span>
                        {% endif %}
                      </td>
                      <td><strong>{{ product.bidhaa__jina }}</strong></td>
                      <td>
                        <span class="badge badge-success">{{ product.total_quantity }} units</span>
                      </td>
                      <td>
                        <strong class="text-success">{{ product.total_revenue|floatformat:2 }} TZS</strong>
                      </td>
                      <td>
                        <a href="{% url 'view_bidhaa' bidhaa_id=product.bidhaa__id %}" 
                           class="btn btn-info btn-sm">
                          <i class="fas fa-eye"></i> View
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <div class="text-center p-5">
                <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                <p>No sales data available yet</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Recent Sales -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-clock"></i> Recent Sales
            </h3>
            <div class="card-tools">
              <a href="{% url 'sales_history' %}" class="btn btn-tool">
                <i class="fas fa-list"></i> View All
              </a>
            </div>
          </div>
          <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
            {% if recent_sales %}
              <ul class="products-list product-list-in-card pl-2 pr-2">
                {% for sale in recent_sales %}
                  <li class="item">
                    <div class="product-img">
                      <div class="bg-info d-flex align-items-center justify-content-center" 
                           style="width:50px; height:50px; border-radius:5px;">
                        <i class="fas fa-receipt text-white"></i>
                      </div>
                    </div>
                    <div class="product-info">
                      <a href="{% url 'view_sale' sale_id=sale.id %}" class="product-title">
                        {{ sale.sale_number }}
                        {% if sale.status == 'completed' %}
                          <span class="badge badge-success float-right">Paid</span>
                        {% elif sale.status == 'pending' %}
                          <span class="badge badge-warning float-right">Pending</span>
                        {% endif %}
                      </a>
                      <span class="product-description">
                        {% if sale.customer_name %}
                          {{ sale.customer_name }}
                        {% else %}
                          Walk-in Customer
                        {% endif %}
                        <br>
                        <small class="text-muted">{{ sale.sale_date|date:"M d, H:i" }}</small>
                        <br>
                        <strong class="text-success">{{ sale.total_amount|floatformat:2 }} TZS</strong>
                      </span>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-center p-4">
                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                <p class="text-muted">No recent sales</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Sales by Payment Method & Status -->
    <div class="row">
      <!-- Payment Methods Chart -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-credit-card"></i> Sales by Payment Method (This Month)
            </h3>
          </div>
          <div class="card-body">
            <canvas id="paymentMethodChart" style="height: 250px;"></canvas>
          </div>
        </div>
      </div>

      <!-- Daily Sales Trend -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-chart-line"></i> Daily Sales Trend (Last 7 Days)
            </h3>
          </div>
          <div class="card-body">
            <canvas id="dailySalesChart" style="height: 250px;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Links -->
    <div class="row">
      <div class="col-12">
        <div class="card card-outline card-primary">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-link"></i> Quick Links
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <a href="{% url 'make_sale' %}" class="btn btn-app bg-success btn-lg btn-block">
                  <i class="fas fa-cash-register"></i> New Sale
                </a>
              </div>
              <div class="col-md-3">
                <a href="{% url 'sales_history' %}" class="btn btn-app bg-info btn-lg btn-block">
                  <i class="fas fa-history"></i> Sales History
                </a>
              </div>
              <div class="col-md-3">
                <a href="{% url 'manage_bidhaa' %}" class="btn btn-app bg-warning btn-lg btn-block">
                  <i class="fas fa-box"></i> Manage Products
                </a>
              </div>
              <div class="col-md-3">
                <a href="{% url 'low_stock_alert' %}" class="btn btn-app bg-danger btn-lg btn-block">
                  <i class="fas fa-exclamation-triangle"></i> Low Stock
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Payment Method Chart (Pie Chart)
    const paymentCtx = document.getElementById('paymentMethodChart');
    if (paymentCtx) {
        new Chart(paymentCtx, {
            type: 'doughnut',
            data: {
                labels: ['Cash', 'M-Pesa', 'Bank Transfer', 'Credit'],
                datasets: [{
                    data: [45, 30, 15, 10], // Replace with actual data from backend
                    backgroundColor: [
                        '#28a745',
                        '#007bff',
                        '#17a2b8',
                        '#ffc107'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Daily Sales Trend (Line Chart)
    const dailyCtx = document.getElementById('dailySalesChart');
    if (dailyCtx) {
        new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Sales (TZS)',
                    data: [{{ today_total }}, {{ today_total|mul:0.8 }}, {{ today_total|mul:1.2 }}, {{ today_total|mul:0.9 }}, {{ today_total|mul:1.1 }}, {{ today_total|mul:0.7 }}, {{ today_total }}], // Replace with actual data
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderColor: '#007bff',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#007bff',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Sales: ' + context.parsed.y.toLocaleString() + ' TZS';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' TZS';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

<!-- Custom CSS for dashboard -->
<style>
.products-list .product-title {
    font-weight: 600;
}

.btn-app {
    min-width: 100%;
    height: auto;
    padding: 15px 5px;
    margin: 0 0 10px;
    text-align: center;
}

.btn-app > .fa,
.btn-app > .fas,
.btn-app > .far,
.btn-app > .fab,
.btn-app > .fal,
.btn-app > .fad,
.btn-app > .svg-inline--fa,
.btn-app > .ion {
    font-size: 30px;
    display: block;
    margin-bottom: 10px;
}

.small-box {
    border-radius: 5px;
}

.small-box > .inner {
    padding: 10px;
}

.small-box .icon {
    font-size: 70px;
}

.card-header .card-title {
    font-weight: 600;
}
</style>
{% endblock main_content %}