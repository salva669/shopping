{% extends 'hod_template/base_template.html' %}
{% load static %}
{% block page_title %}Offline POS{% endblock page_title %}

{% block main_content %}
<section class="content">
  <div class="container-fluid">
    
    <!-- Connection Status Bar -->
    <div id="connection-status" class="alert alert-info">
      <i class="fas fa-wifi"></i>
      <span id="status-text">Checking connection...</span>
      <button id="sync-btn" class="btn btn-sm btn-primary float-right" onclick="manualSync()">
        <i class="fas fa-sync"></i> Sync Now
      </button>
      <span id="sync-status" class="badge badge-secondary float-right mr-2"></span>
    </div>

    <div class="row">
      <!-- Products (Left) -->
      <div class="col-md-7">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Products</h3>
            <div class="card-tools">
              <input type="text" id="product-search" class="form-control form-control-sm" 
                     placeholder="Search products..." onkeyup="searchProducts()">
            </div>
          </div>
          <div class="card-body" style="max-height: 600px; overflow-y: auto;">
            <div id="products-container" class="row">
              <!-- Products will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Cart (Right) -->
      <div class="col-md-5">
        <div class="card card-primary sticky-top" style="top: 20px;">
          <div class="card-header">
            <h3 class="card-title">Cart</h3>
            <span class="badge badge-warning float-right" id="cart-count">0 items</span>
          </div>
          <div class="card-body" style="max-height: 400px; overflow-y: auto;">
            <div id="cart-items">
              <p class="text-center text-muted">Cart is empty</p>
            </div>
          </div>
          <div class="card-footer">
            <div class="row mb-3">
              <div class="col-6">
                <strong>Total:</strong>
              </div>
              <div class="col-6 text-right">
                <h4 class="text-success mb-0" id="cart-total">0.00 TZS</h4>
              </div>
            </div>
            <button class="btn btn-success btn-block btn-lg" onclick="openCheckout()" id="checkout-btn" disabled>
              <i class="fas fa-check"></i> Checkout
            </button>
            <button class="btn btn-danger btn-block" onclick="clearCart()">
              <i class="fas fa-trash"></i> Clear Cart
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success">
        <h5 class="modal-title text-white">Complete Sale</h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="checkoutForm">
          <div class="form-group">
            <label>Customer Name (Optional)</label>
            <input type="text" id="customer_name" class="form-control" placeholder="Customer name">
          </div>
          <div class="form-group">
            <label>Customer Phone (Optional)</label>
            <input type="tel" id="customer_phone" class="form-control" placeholder="+255...">
          </div>
          <div class="form-group">
            <label>Payment Method</label>
            <select id="payment_method" class="form-control">
              <option value="cash">Cash</option>
              <option value="mpesa">M-Pesa</option>
              <option value="bank">Bank Transfer</option>
              <option value="credit">Credit</option>
            </select>
          </div>
          <div class="alert alert-info">
            <strong>Total Amount:</strong>
            <h4 class="mb-0" id="checkout-total">0.00 TZS</h4>
          </div>
          <div id="offline-warning" class="alert alert-warning" style="display:none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Offline Mode:</strong> Sale will be saved locally and synced when connection is restored.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="completeSaleOffline()">
          <i class="fas fa-check"></i> Complete Sale
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Include Scripts -->
<script src="{% static 'js/db-manager.js' %}"></script>
<script src="{% static 'js/sync-manager.js' %}"></script>
<script src="{% static 'js/offline-pos.js' %}"></script>

<script>
// Update connection status
function updateConnectionStatus() {
  const statusBar = document.getElementById('connection-status');
  const statusText = document.getElementById('status-text');
  const offlineWarning = document.getElementById('offline-warning');
  
  if (navigator.onLine) {
    statusBar.className = 'alert alert-success';
    statusText.innerHTML = '<i class="fas fa-wifi"></i> Online - Data will sync automatically';
    if (offlineWarning) offlineWarning.style.display = 'none';
  } else {
    statusBar.className = 'alert alert-warning';
    statusText.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline - Working in offline mode';
    if (offlineWarning) offlineWarning.style.display = 'block';
  }
}

// Manual sync trigger
async function manualSync() {
  const btn = document.getElementById('sync-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
  
  try {
    await syncManager.fullSync();
  } catch (error) {
    console.error('Sync failed:', error);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-sync"></i> Sync Now';
  }
}

// Search products
function searchProducts() {
  const query = document.getElementById('product-search').value.toLowerCase();
  const cards = document.querySelectorAll('.product-card');
  
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    card.style.display = text.includes(query) ? 'block' : 'none';
  });
}

// Open checkout modal
function openCheckout() {
  if (offlinePOS.cart.length === 0) {
    alert('Cart is empty');
    return;
  }
  
  const total = offlinePOS.cart.reduce((sum, item) => 
    sum + (item.quantity * item.unit_price), 0
  );
  
  document.getElementById('checkout-total').textContent = total.toFixed(2) + ' TZS';
  
  // Show offline warning if offline
  const warning = document.getElementById('offline-warning');
  if (!navigator.onLine && warning) {
    warning.style.display = 'block';
  }
  
  $('#checkoutModal').modal('show');
}

// Complete sale in offline mode
async function completeSaleOffline() {
  try {
    await offlinePOS.completeSale();
    $('#checkoutModal').modal('hide');
    alert('Sale completed! Will sync when online.');
  } catch (error) {
    console.error('Error completing sale:', error);
    alert('Failed to complete sale');
  }
}

// Clear cart
function clearCart() {
  if (confirm('Clear cart?')) {
    offlinePOS.cart = [];
    offlinePOS.updateCartDisplay();
  }
}

// Event listeners
window.addEventListener('online', updateConnectionStatus);
window.addEventListener('offline', updateConnectionStatus);

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
  updateConnectionStatus();
  
  // Initialize offline POS
  offlinePOS = new OfflinePOS(dbManager, syncManager);
  await offlinePOS.init();
  
  // Update cart display
  offlinePOS.updateCartDisplay();
  
  // Enable/disable checkout button
  setInterval(() => {
    const btn = document.getElementById('checkout-btn');
    btn.disabled = offlinePOS.cart.length === 0;
    document.getElementById('cart-count').textContent = offlinePOS.cart.length + ' items';
  }, 500);
});
</script>

<style>
.product-card {
  border: 1px solid #ddd;
  border-radius: 5px;
  padding: 10px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.3s;
}

.product-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

.product-card img {
  width: 100%;
  height: 100px;
  object-fit: cover;
  border-radius: 3px;
  margin-bottom: 5px;
}

.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #eee;
}

.cart-item button {
  padding: 3px 8px;
  font-size: 12px;
}

#connection-status {
  margin-bottom: 20px;
  padding: 15px;
}
</style>
{% endblock main_content %}